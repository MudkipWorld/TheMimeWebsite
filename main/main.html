<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="../news/news.css" />
    <link rel="stylesheet" href="../main/main.css" />
    <title>Main Page</title>
    <script>
        const ts = new Date().getTime();
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
                link.href += "?v=" + ts;
            });

            document.querySelectorAll('script[src]').forEach(script => {
                script.src += "?v=" + ts;
            });
        });
    </script>
</head>
<body>
    <div class="flex-container">
        <div class="row_flex_container">
            <img src="../assets/main_page_assets/themime_logo.svg" alt="Mime Logo" onclick="loadPage('')" class="logo_image"/>
            <div class="top_buttons_div">
                <div class="top_buttons_container">
                    <button class="top_buttons blue"   onclick="loadPage('../news/news.html')">News</button>
                    <button class="top_buttons yellow" onclick="loadPage('../projects/projects.html')">Projects</button>
                    <button class="top_buttons darkblue" onclick="loadNewPage('../games/unique_aquarium_page/uapage.html')">Aquarium</button>
                    <button class="top_buttons green"  onclick="loadPage('../games/games.html')">Mini Games</button>
                </div>
            </div>
        </div>

        <div class="bodybg">
            <div id="subview" style="font-family: 'MouldyCheese'">
                <h1 align="center">Welcome!</h1>
                <h2 align="center">Feel free to look around!</h2>
                <div class="main_colored_background"></div>
                <div class="main_container">
                    <img src="../assets/main_page_assets/me.png" alt="me" class="bio_image"/>
                    <div class="news_background">
                        <p class="bio_text">
                            Hello! I am TheMime. I am an artist, animator and a programmer. I am mainly known for developing PNGTube-Remix and in tiny communities, being the developer behind Unique Aquarium. This is my official page. Feel free to take a look! 
                            <br>You can check some news/ updates here and play some games too!
                            <br><br><br>(Idk how to make websites, help.)
                        </p>
                        <a href="https://ko-fi.com/themime2111"  target="_blank" rel="noopener noreferrer">
                            <button class="play_button" style="display: contents;">
                                <p align="right">Buy me Kofi!</p>
                            </button>
                        </a>  
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../games/games/TestExport/CatCross.js?v=<?= new Date().getTime() ?>"></script>

<script>
const originalSubviewHTML = document.getElementById("subview").innerHTML;
const timestamp = new Date().getTime();

function loadPage(page) {
    if (page === '') {
        document.getElementById("subview").innerHTML = originalSubviewHTML;
        sessionStorage.removeItem("lastPage");
        history.replaceState(null, '', window.location.pathname);
        return;
    }

    fetch(page + "?v=" + timestamp)
        .then(response => response.text())
        .then(html => {
            document.getElementById("subview").innerHTML = html;
            sessionStorage.setItem("lastPage", page);
            setupFullscreen();
            history.replaceState(null, '', window.location.pathname + "?page=" + page);
        })
        .catch(error => {
            document.getElementById("subview").innerHTML = "Error!";
        });
}

window.addEventListener("DOMContentLoaded", () => {
    const urlParams = new URLSearchParams(window.location.search);
    const pageParam = urlParams.get("page");
    const hash = window.location.hash.substring(1); 

    if (pageParam) {
        loadPage(pageParam);
    } else if (hash) {

        const pageMap = {
            news: "../news/news.html",
            projects: "../projects/projects.html",
            mini: "../games/games.html"
        };
        if (pageMap[hash]) loadPage(pageMap[hash]);
    } else {
        const lastPage = sessionStorage.getItem("lastPage");
        if (lastPage) loadPage(lastPage);
    }
});


function loadNewPage(page) {
    window.location.href = page + "?v=" + timestamp;
}

function loadPageGame(page, game) {
    if (page == '') {
        document.getElementById("subview").innerHTML = originalSubviewHTML;
        sessionStorage.removeItem("lastPage");
        return;
    }

    fetch(page + "?v=" + timestamp)
        .then(response => response.text())
        .then(html => {
            document.getElementById("subview").innerHTML = html;
            sessionStorage.setItem("lastPage", page);
            setupFullscreen();
            load_game(game);
        })
        .catch(error => {
            document.getElementById("subview").innerHTML = "Error!";
        });
}

function load_game(url, width = 1280, height = 720) {
    const gameGrid = document.getElementById('gameGrid');
    if (gameGrid) gameGrid.style.display = 'none';

    const gamePlayer = document.getElementById('GamePlayer');
    if (gamePlayer) gamePlayer.style.display = 'flex';

    const iframe = document.getElementById('GameEmbed');
    if (iframe) iframe.src = url + "?v=" + ts;

    const wrapper = document.getElementById('game_wrapper');
    if (wrapper) wrapper.style.aspectRatio = `${width} / ${height}`;
}


function exit_game() {
    const iframe = document.getElementById('GameEmbed');
    if (iframe) iframe.src = '';
    const gamePlayer = document.getElementById('GamePlayer');
    if (gamePlayer) gamePlayer.style.display = 'none';
    const gameGrid = document.getElementById('gameGrid');
    if (gameGrid) gameGrid.style.display = 'contents';
}

document.getElementById('fullscreenButton')?.addEventListener('click', () => {
    const iframe = document.getElementById('GameEmbed');
    if (iframe?.requestFullscreen) iframe.requestFullscreen();
});

function resize_iframe_to_canvas() {
    const iframe = document.getElementById('GameEmbed');
    if (!iframe || !iframe.contentWindow) return;
    const canvas = iframe.contentWindow.document.getElementById('canvas');
    if (!canvas) return;
    canvas.width = iframe.clientWidth + "px";
    canvas.height = iframe.clientHeight + "px";
}

function setupFullscreen() {
    const fullscreenButton = document.getElementById('fullscreenButton');
    const iframeWrapper = document.getElementById('game_wrapper');
    if (!fullscreenButton || !iframeWrapper) return;

    fullscreenButton.addEventListener('click', () => {
        if (!document.fullscreenElement) {
            iframeWrapper.requestFullscreen?.() || iframeWrapper.webkitRequestFullscreen?.() || iframeWrapper.msRequestFullscreen?.();
        } else {
            document.exitFullscreen?.() || document.webkitExitFullscreen?.() || document.msExitFullscreen?.();
        }
    });

    document.addEventListener('fullscreenchange', () => {
        if (fullscreenButton) fullscreenButton.textContent = document.fullscreenElement ? 'Fullscreen' : 'Fullscreen';
    });
}

window.addEventListener('resize', resize_iframe_to_canvas);
</script>
